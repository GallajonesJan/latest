<!-- UPDATED healthlogs.html with debug logs restored -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Logs | AI Health Monitor</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Scrollable table wrapper */
    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: white;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='dashboard.html'">â† Back</button>
  <div class="dashboard-container">
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html" class="active">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="./device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">
        
  <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
  AlertoBot
</a>
        <a href="./about.html">â„¹ï¸ About</a>
        <a href="./signin.html">ğŸšª Logout</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="dashboard-header">
        <h1 id="welcome-text">Health Logs</h1>
        <p>Your recent monitoring records from ESP32 sensor</p>
      </header>

      <section class="live-vitals">
        <h2>ğŸ“¡ Latest Reading</h2>
        <div class="vitals-grid">
          <div class="vital-box"><h3>â¤ï¸ Heart Rate</h3><p id="live-heart-rate">â€”</p></div>
          <div class="vital-box"><h3>ğŸŒ¬ï¸ SpOâ‚‚</h3><p id="live-spo2">â€”</p></div>
          <div class="vital-box"><h3>ğŸ•’ Timestamp</h3><p id="live-timestamp">â€”</p></div>
        </div>
      </section>

      <section class="logs-section">
        <h2>ğŸ“‹ Recent Health Records</h2>
        <button id="refresh-btn">ğŸ”„ Refresh</button>

        <div class="table-wrapper">
          <table class="logs-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>â¤ï¸ Heart Rate (BPM)</th>
                <th>ğŸŒ¬ï¸ SpOâ‚‚ (%)</th>
                <th>IR Value</th>
                <th>RED Value</th>
              </tr>
            </thead>
            <tbody id="health-log-body">
              <tr><td colspan="6" style="text-align:center; padding:20px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
<!--
      <section class="chart-section">
        <h2>ğŸ“ˆ Health Trends</h2>
        <canvas id="healthChart" width="800" height="300"></canvas>
      </section>
      -->
    </main>
  </div>

  <script>
    const FLASK_URL = 'http://192.168.100.13:5000';
    const token = localStorage.getItem("access_token");
    const tableBody = document.getElementById("health-log-body");
    const refreshBtn = document.getElementById("refresh-btn");
    let chart;

    function formatDateTime(iso) {
      if (!iso || isNaN(Date.parse(iso))) return { date: "â€”", time: "â€”", raw: null };
      const d = new Date(iso);
      return {
        date: d.toLocaleDateString("en-CA"),
        time: d.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', second: '2-digit' })
      };
    }

    function renderRow(record) {
      const { date, time } = formatDateTime(record.timestamp);
      return `
        <tr>
          <td>${date}</td>
          <td>${time}</td>
          <td>${record.heart_rate ?? "â€”"}</td>
          <td>${record.spo2 ?? "â€”"}</td>
          <td>${record.ir ?? "â€”"}</td>
          <td>${record.red ?? "â€”"}</td>
        </tr>`;
    }

    function updateLatestVitals(records) {
      if (records.length > 0) {
        const latest = records[0];
        document.getElementById("live-heart-rate").textContent = latest.heart_rate ?? "â€”";
        document.getElementById("live-spo2").textContent = latest.spo2 ?? "â€”";
        document.getElementById("live-timestamp").textContent = formatDateTime(latest.timestamp).time;
      }
    }

    function renderChart(records) {
      const chartData = records.slice(0, 10).reverse();
      const labels = chartData.map(r => formatDateTime(r.timestamp).time);
      const hr = chartData.map(r => r.heart_rate || 0);
      const spo = chartData.map(r => r.spo2 || 0);

      if (chart) chart.destroy();

      chart = new Chart(document.getElementById("healthChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Heart Rate", data: hr, borderColor: "#FF6384", backgroundColor: "rgba(255,99,132,0.1)", fill: true },
            { label: "SpOâ‚‚", data: spo, borderColor: "#36A2EB", backgroundColor: "rgba(54,162,235,0.1)", fill: true }
          ]
        }
      });
    }

    async function loadHealthLogs() {
      console.log("ğŸ“¡ Fetching Health logs from Flask...");

      if (!token) {
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">âš ï¸ Please log in first</td></tr>`;
        return;
      }

      try {
        const res = await fetch(`${FLASK_URL}/healthlogs`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const records = await res.json();
        console.log("âœ… Received records:", records);

        if (!records.length) {
          tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">ğŸ“­ No health records found.</td></tr>`;
          return;
        }

        tableBody.innerHTML = records.map(renderRow).join("");
        updateLatestVitals(records);
        renderChart(records);

      } catch (err) {
        console.error("âŒ Error loading records:", err);
        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">âš ï¸ ${err.message}</td></tr>`;
      }
    }

    refreshBtn.addEventListener("click", loadHealthLogs);
    loadHealthLogs();
    setInterval(loadHealthLogs, 5000);

    
  </script>
</body>
</html>
